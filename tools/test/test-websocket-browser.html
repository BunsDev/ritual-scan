<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket Debug Tool - Ritual Scan</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            background: #000;
            color: #84cc16;
            padding: 20px;
            margin: 0;
        }
        h1 {
            color: #84cc16;
            border-bottom: 2px solid #84cc16;
            padding-bottom: 10px;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            border: 1px solid #84cc16;
        }
        .connected {
            background: rgba(132, 204, 22, 0.1);
            border-color: #84cc16;
        }
        .disconnected {
            background: rgba(239, 68, 68, 0.1);
            border-color: #ef4444;
            color: #ef4444;
        }
        .message {
            background: rgba(132, 204, 22, 0.05);
            border: 1px solid #84cc16;
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
            overflow-x: auto;
        }
        .message-header {
            font-weight: bold;
            color: #fff;
            margin-bottom: 5px;
        }
        .block-message {
            border-color: #22c55e;
            background: rgba(34, 197, 94, 0.1);
        }
        .tx-message {
            border-color: #3b82f6;
            background: rgba(59, 130, 246, 0.1);
        }
        .error-message {
            border-color: #ef4444;
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
        }
        pre {
            background: #111;
            padding: 10px;
            border-radius: 3px;
            overflow-x: auto;
            color: #84cc16;
        }
        button {
            background: #84cc16;
            color: #000;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            margin: 5px;
        }
        button:hover {
            background: #65a30d;
        }
        button:disabled {
            background: #333;
            color: #666;
            cursor: not-allowed;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin: 20px 0;
        }
        .stat-box {
            background: rgba(132, 204, 22, 0.1);
            border: 1px solid #84cc16;
            border-radius: 5px;
            padding: 15px;
            text-align: center;
        }
        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #fff;
        }
        .stat-label {
            font-size: 0.8em;
            color: #84cc16;
            text-transform: uppercase;
        }
    </style>
</head>
<body>
    <h1>üîç WebSocket Debug Tool - Ritual Scan</h1>
    
    <div id="status" class="status disconnected">
        ‚è≥ Not connected
    </div>

    <div>
        <input type="text" id="wsUrl" value="ws://35.196.101.134:8546" 
               style="width: 400px; padding: 10px; background: #111; border: 1px solid #84cc16; color: #84cc16; border-radius: 5px;">
        <button onclick="connect()">Connect</button>
        <button onclick="disconnect()">Disconnect</button>
        <button onclick="clearLogs()">Clear Logs</button>
    </div>

    <div class="stats">
        <div class="stat-box">
            <div class="stat-value" id="blockCount">0</div>
            <div class="stat-label">Blocks Received</div>
        </div>
        <div class="stat-box">
            <div class="stat-value" id="txCount">0</div>
            <div class="stat-label">Transactions</div>
        </div>
        <div class="stat-box">
            <div class="stat-value" id="messageCount">0</div>
            <div class="stat-label">Total Messages</div>
        </div>
        <div class="stat-box">
            <div class="stat-value" id="latestBlock">-</div>
            <div class="stat-label">Latest Block</div>
        </div>
    </div>

    <h2>üìä Message Log</h2>
    <div id="messages"></div>

    <script>
        let ws = null;
        let blockCount = 0;
        let txCount = 0;
        let messageCount = 0;

        function connect() {
            const url = document.getElementById('wsUrl').value;
            console.log('üîó Connecting to:', url);
            
            try {
                ws = new WebSocket(url);
                
                ws.onopen = () => {
                    console.log('‚úÖ WebSocket connected');
                    updateStatus('‚úÖ Connected', true);
                    
                    // Subscribe to newHeads
                    const blockSubscription = {
                        jsonrpc: '2.0',
                        method: 'eth_subscribe',
                        params: ['newHeads'],
                        id: 1
                    };
                    
                    // Subscribe to pending transactions
                    const txSubscription = {
                        jsonrpc: '2.0',
                        method: 'eth_subscribe',
                        params: ['newPendingTransactions'],
                        id: 2
                    };
                    
                    console.log('üì§ Sending subscriptions...');
                    ws.send(JSON.stringify(blockSubscription));
                    ws.send(JSON.stringify(txSubscription));
                    
                    addMessage('info', 'Subscriptions sent', {
                        blockSubscription,
                        txSubscription
                    });
                };
                
                ws.onmessage = (event) => {
                    messageCount++;
                    document.getElementById('messageCount').textContent = messageCount;
                    
                    try {
                        const message = JSON.parse(event.data);
                        console.log('üì© Message received:', message);
                        
                        // Check if it's a subscription confirmation
                        if (message.id && message.result) {
                            addMessage('info', `Subscription confirmed: ${message.result}`, message);
                        }
                        // Check if it's a subscription message
                        else if (message.method === 'eth_subscription') {
                            const result = message.params?.result;
                            const subscription = message.params?.subscription;
                            
                            // Check if it's a block header
                            if (result && typeof result === 'object') {
                                // Log all keys to help debug
                                console.log('üîç Result keys:', Object.keys(result));
                                console.log('üîç Has number?', 'number' in result);
                                console.log('üîç Has hash?', 'hash' in result);
                                console.log('üîç Has parentHash?', 'parentHash' in result);
                                
                                const isBlockHeader = result.number || result.hash || result.parentHash || result.miner;
                                
                                if (isBlockHeader) {
                                    blockCount++;
                                    document.getElementById('blockCount').textContent = blockCount;
                                    
                                    const blockNum = result.number ? parseInt(result.number, 16) : '?';
                                    document.getElementById('latestBlock').textContent = blockNum;
                                    
                                    addMessage('block', `üéâ NEW BLOCK #${blockNum}`, {
                                        subscription,
                                        keys: Object.keys(result),
                                        result
                                    });
                                } else if (typeof result === 'string' && result.startsWith('0x')) {
                                    txCount++;
                                    document.getElementById('txCount').textContent = txCount;
                                    addMessage('tx', `‚ö° New pending tx: ${result.slice(0, 10)}...`, message);
                                } else {
                                    addMessage('info', 'Unknown subscription result', {
                                        subscription,
                                        resultType: typeof result,
                                        keys: result ? Object.keys(result) : null,
                                        result
                                    });
                                }
                            } else if (typeof result === 'string') {
                                txCount++;
                                document.getElementById('txCount').textContent = txCount;
                                addMessage('tx', `‚ö° New pending tx: ${result.slice(0, 10)}...`, message);
                            }
                        }
                        // Unknown message type
                        else {
                            addMessage('info', 'Other message', message);
                        }
                    } catch (error) {
                        console.error('‚ùå Failed to parse message:', error);
                        addMessage('error', `Parse error: ${error.message}`, { raw: event.data });
                    }
                };
                
                ws.onerror = (error) => {
                    console.error('‚ùå WebSocket error:', error);
                    updateStatus('‚ùå Error: ' + error.message, false);
                };
                
                ws.onclose = (event) => {
                    console.log('üîå WebSocket closed:', event.code, event.reason);
                    updateStatus(`üîå Disconnected (${event.code})`, false);
                };
                
            } catch (error) {
                console.error('‚ùå Failed to create WebSocket:', error);
                updateStatus('‚ùå Failed: ' + error.message, false);
            }
        }
        
        function disconnect() {
            if (ws) {
                ws.close();
                ws = null;
            }
        }
        
        function updateStatus(text, isConnected) {
            const statusEl = document.getElementById('status');
            statusEl.textContent = text;
            statusEl.className = 'status ' + (isConnected ? 'connected' : 'disconnected');
        }
        
        function addMessage(type, header, data) {
            const messagesEl = document.getElementById('messages');
            const messageEl = document.createElement('div');
            
            let className = 'message';
            if (type === 'block') className += ' block-message';
            else if (type === 'tx') className += ' tx-message';
            else if (type === 'error') className += ' error-message';
            
            messageEl.className = className;
            messageEl.innerHTML = `
                <div class="message-header">${new Date().toLocaleTimeString()} - ${header}</div>
                <pre>${JSON.stringify(data, null, 2)}</pre>
            `;
            
            // Add to top of messages
            messagesEl.insertBefore(messageEl, messagesEl.firstChild);
            
            // Keep only last 50 messages
            while (messagesEl.children.length > 50) {
                messagesEl.removeChild(messagesEl.lastChild);
            }
        }
        
        function clearLogs() {
            document.getElementById('messages').innerHTML = '';
            blockCount = 0;
            txCount = 0;
            messageCount = 0;
            document.getElementById('blockCount').textContent = 0;
            document.getElementById('txCount').textContent = 0;
            document.getElementById('messageCount').textContent = 0;
            document.getElementById('latestBlock').textContent = '-';
        }
        
        // Auto-connect on load
        window.onload = () => {
            console.log('üöÄ WebSocket Debug Tool loaded');
            // Uncomment to auto-connect:
            // setTimeout(connect, 500);
        };
    </script>
</body>
</html>

