apiVersion: v1
kind: ConfigMap
metadata:
  name: caddy-ws-proxy-config
data:
  Caddyfile: |
    # WebSocket proxy on port 443 (accepts any host/IP)
    :443 {
        tls internal
        
        # Proxy all WebSocket requests to RPC node
        reverse_proxy 35.196.101.134:8546 {
            header_up Host {upstream_hostport}
            header_up Upgrade {http.request.header.Upgrade}
            header_up Connection {http.request.header.Connection}
        }
    }
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: caddy-ws-proxy
spec:
  replicas: 2
  selector:
    matchLabels:
      app: caddy-ws-proxy
  template:
    metadata:
      labels:
        app: caddy-ws-proxy
    spec:
      containers:
      - name: caddy
        image: caddy:2-alpine
        ports:
        - containerPort: 443
          name: https
        - containerPort: 8546
          name: websocket
        volumeMounts:
        - name: caddy-config
          mountPath: /etc/caddy/Caddyfile
          subPath: Caddyfile
        resources:
          requests:
            memory: "128Mi"
            cpu: "100m"
          limits:
            memory: "256Mi"
            cpu: "200m"
        livenessProbe:
          tcpSocket:
            port: 443
          initialDelaySeconds: 5
          periodSeconds: 10
        readinessProbe:
          tcpSocket:
            port: 443
          initialDelaySeconds: 3
          periodSeconds: 5
      volumes:
      - name: caddy-config
        configMap:
          name: caddy-ws-proxy-config
---
apiVersion: v1
kind: Service
metadata:
  name: caddy-ws-proxy-service
  annotations:
    cloud.google.com/backend-config: '{"default": "ws-proxy-backend-config"}'
spec:
  type: ClusterIP
  selector:
    app: caddy-ws-proxy
  ports:
  - name: websocket
    port: 8546
    targetPort: 8546
    protocol: TCP
---
apiVersion: cloud.google.com/v1
kind: BackendConfig
metadata:
  name: ws-proxy-backend-config
spec:
  timeoutSec: 86400  # 24 hours for WebSocket connections
  connectionDraining:
    drainingTimeoutSec: 60
  # Force HTTP/1.1 for WebSocket support (HTTP/2 doesn't support Upgrade header)
  customRequestHeaders:
    headers:
    - "Connection:Upgrade"
    - "Upgrade:websocket"

